# Система автоматического наведения для БПЛА [ROS2, Gazebo 11]
* *Проверено на ROS2 Iron*
* *Для симуляции БПЛА используется проект с открытым исходным кодом [sjtu_drone](https://github.com/NovoG93/sjtu_drone)*

## Интро
[![](https://markdown-videos-api.jorgenkh.no/youtube/UuhIjWzZhvc)](https://youtu.be/UuhIjWzZhvc)

## Краткое описание нодов
- *target_processor* - следит за указанным объектом через камеру дрона, передает координаты объекта на изображении в топик
- *pid_controller* - получает актуальные координаты объекта, корректирует высоту и курс робота в соответствии с полученными данными

## Доступные топики

### target_processor
- image_topic [__sensor_msgs/msg/Image__] - видеопоток с камеры дрона, по умолчанию установлен на */simple_drone/front/image_raw*
- output_topic [__geometry_msgs/msg/Pose2D__] - координаты отслеживаемого объекта на изображении, по умолчанию - */tracked_object*

*Имена топиков возможно менять в конфигурационном файле, который располагается по пути target_processor/config/processor_params.yaml. После изменения конфигурационного файла обязательно пересоберите проект.*

### pid_controller
- input_topic [__geometry_msgs/msg/Pose2D__] - координаты отслеживаемого объекта на изображении, по умолчанию - */tracked_object*
- output_topic [__geometry_msgs/msg/Twist__] - публикуемые линейные и угловые скорости дрона, по умолчанию - */simple_drone/cmd_vel*
- ~/yaw_pid/setpoint [__std_msgs/msg/Float64__] - setpoint для PID-регулятора курса дрона
- ~/height_pid/setpoint [__std_msgs/msg/Float64__] - setpoint для PID-регулятора высоты дрона

*Имена топиков возможно менять в конфигурационном файле, который располагается по пути pid_controller/config/processor_params.yaml. После изменения конфигурационного файла обязательно пересоберите проект.*

## Доступные сервисы

### pid_controller
- ~/yaw_pid/switch [__std_srvs/srv/SetBool__] - включение/выключение PID-регулятора отвечающего за удержание курса
- ~/height_pid/switch [__std_srvs/srv/SetBool__] - включение/выключение PID-регулятора отвечающего за удержание высоты
- ~/enable [__std_srvs/srv/SetBool__] - включение/выключение системы управления дрона

## Сборка проекта
*Установите актуальную версию ROS2, например, Iron или Hamble.* 
Инструкции по установке ROS2:
* [Iron](https://docs.ros.org/en/iron/Installation.html)
* [Humble](https://docs.ros.org/en/humble/Installation.html)

Создайте рабочее пространство, если его еще нет
```bash
mkdir -p ~/ros2_ws/src
```

Перейдите в рабочее пространство и клонируйте репозиторий проекта
```bash
cd ~/ros2_ws/src
git clone --recursive https://github.com/Artemy2807/tracker_ros2.git
```

Установите зависимости
```bash
cd ~/ros2_ws
rosdep install -r -y --from-paths src --ignore-src --rosdistro $ROS_DISTRO
```

Финальный шаг, начните сборку с помощью следующей команды
```bash
colcon build
```

## Настройка рабочего пространства
Перед работой инициализируйте рабочее пространство
```bash
source ~/ros2_ws/install/setup.bash
```

Чтобы не выполнять эту команду каждый раз при открытии терминала, добавьте ее в файл *~/.bashrc*
```bash
echo 'source ~/ros2_ws/install/setup.bash' >> ~/.bashrc
```

После этого перезапустите терминал или выполните команду
```bash
source ~/.bashrc
```

## Инструкция по запуску
Запуск симулятора с базовой сценой и квадрокоптером
```bash
ros2 launch sjtu_drone_bringup sjtu_drone_bringup.launch.py
```

После выполнения команды откроется симулятор gazebo, rviz и терминал для ручного управления квадрокоптером с клавиатуры. Для осуществления взлета в этом терминале необходимо нажать клавишу *'t'*. После чего можно переходить к работе с системой автоматического наведения.

В другом терминале. Запуск системы автоматического наведения на цель
```bash
ros2 launch target_processor default.launch.py
```

Откроется окно с изображением, получаемым с передней камеры квадрокоптера. Нажмите на интересующую цель на этом изображении. После чего коптер начнет автоматически ее удерживать и преследовать.

## Настройка PID-регуляторов
Для осуществления преследования цели используется два PID-регулятора. Один - для корректировки высоты, а второй - для корректировки курса дрона.

*Для ручной корректировки коэффициентов редактируйте файл, который находится по следующему пути*
```bash
~/ros2_ws/src/pid_controller/config/controller_params.yaml
```

После изменения параметров, обязательно необходимо пересобрать пакет
```bash
cd ~/ros2_ws
colcon build
```
А также перезапустить систему наведения.

*Для изменения коэффициентов регулятора на 'лету' используйте плагин rqt_reconfigure.*
Установка плагина
```bash
apt-get update
apt-get install -y ros-$ROS_DISTRO-rqt-reconfigure
```

Запуск плагина
```bash
ros2 run rqt_reconfigure rqt_reconfigure
```

После открытия окна, нажмите кнопку refresh и выбирете пункт control_node. В окне появятся параметры PID-регуляторов, которые можно изменять. Для применения параметров нажмите клавишу Enter. 
##### Важно, после нахождения нужных параметров перенесите их в конфигурационный файл, про который говорилось выше. Иначе, при перезапуске системы наведения коэффициенты не сохранятся.
